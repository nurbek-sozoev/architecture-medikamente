# Диаграммы потоков данных (DFD) - As-Is

## Общее описание

Диаграммы потоков данных описывают текущее состояние системы компании "Медикаменте".
Компания использует локальную инфраструктуру: файловый сервер (Windows Server 2022), 1С:Бухгалтерия, 1С:Торговля и склад, Excel-файлы на общем диске, Exchange Mail Server и ККМ.

Все операции с данными производятся вручную. Контроль доступа ограничен доменной аутентификацией Active Directory. Аудит действий не ведется.

---

## Контекстная диаграмма

Общий обзор потоков данных между внешними субъектами и системой "Медикаменте".
![alt text](<DFD-Контекстная диаграмма.drawio.png>)

## Основные процессы

### Процесс 1: Регистрация пациента

Администратор ресепшена регистрирует нового пациента в системе, собирая персональные данные.

![alt text](<DFD-П1. Регистрация пациента.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| ФИО | Excel (Patients.xlsx) | Высокий |
| Дата рождения | Excel (Patients.xlsx) | Высокий |
| Телефон | Excel (Patients.xlsx) | Высокий |
| Email | Excel (Patients.xlsx) | Средний |
| Адрес прописки | Excel / скан | Высокий |
| Место работы/учебы | Excel / скан | Средний |
| Хронические заболевания | Excel / скан | Очень Высокий |
| Скан паспорта | JPG/PDF | Очень Высокий |

**Проблемы:**

- Данные хранятся в открытом виде на общем диске без шифрования
- Нет разграничения доступа к файлам (все сотрудники видят все данные)
- Нет журнала аудита действий с персональными данными
- Собираются избыточные данные (адрес, место работы), которые не нужны для регистрации
- Нет электронного реестра согласий на обработку данных - бумажные формы не отслеживаются
- Папки пациентов именуются по ФИО и дате рождения - персональные данные видны в структуре файловой системы даже без открытия файлов

**Улучшения (целевое состояние):**

- Перенести данные из Excel в базу данных PostgreSQL с прозрачным шифрованием хранилища и разграничением доступа на уровне строк (каждый сотрудник видит только те записи, к которым имеет право)
- Документы пациентов (сканы, фото) перенести в защищенное файловое хранилище с шифрованием
- Управление доступом через единый центр авторизации с подтверждением личности в два шага (пароль/код из приложения)
- Разделить роли: администратор ресепшена может создавать и редактировать карточки, врач - только читать данные своих пациентов
- Вести журнал всех действий - кто, когда и какую запись просматривал или изменял
- Создать электронный реестр согласий с автоматическим контролем сроков
- Вместо ФИО в именах папок использовать обезличенный идентификатор
- Не запрашивать адрес и место работы при регистрации, если они не нужны для лечения (минимизация данных)

---

### Процесс 2: Запись на прием к специалисту

Администратор записывает пациента к конкретному врачу в журнал приема.

![alt text](<DFD-П2. Запись на прием.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| ФИО пациента | Excel (Journal-Doctor-FIO.xlsx) | Высокий |
| Дата и время приема | Excel | Низкий |
| ФИО специалиста | Excel | Низкий |
| Причина обращения | Excel | Высокий |

**Проблемы:**

- Журнал содержит ФИО пациентов - врач видит всех пациентов в журнале, а не только своих
- Файл доступен всем сотрудникам на общем диске
- Нет версионирования и аудита изменений
- Возможен одновременный конфликтующий доступ к файлу (два человека редактируют одновременно - данные теряются)

**Улучшения (целевое состояние):**

- Заменить Excel-журнал на базу данных с разграничением доступа - врач видит только своих пациентов
- Дать пациентам возможность записываться самостоятельно через личный кабинет или мобильное приложение
- Вместо ФИО использовать обезличенный идентификатор, а расшифровку имени хранить отдельно
- Добавить уведомления пациенту (пуш или SMS) с минимумом информации - только дата, время и специальность врача, без персональных данных
- Все запросы проходят через защищенный шлюз с проверкой прав доступа и ограничением частоты запросов
- Каждое создание или изменение записи фиксируется в журнале аудита

---

### Процесс 3: Прием пациента врачом

Врач проводит осмотр, заполняет медицинскую карту, выписывает назначения и направления.

![alt text](<DFD-П3. Медицинский осмотр.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| Жалобы пациента | Excel / Word / скан | Очень Высокий |
| Диагноз | Excel / Word / скан | Очень Высокий |
| Назначения и рецепты | Excel / Word / скан | Очень Высокий |
| Направления на анализы | Excel (RegistryByDate.xlsx) | Высокий |
| История болезни | Файлы в папке пациента | Очень Высокий |

**Проблемы:**

- Медицинские данные хранятся без шифрования
- Любой сотрудник с доступом к общему диску может просмотреть данные любого пациента
- Нет разделения доступа по ролям (врач видит данные не только своих пациентов)
- Нет защиты от копирования и утечки медицинских данных
- Отсутствует механизм подписи врачебных записей - невозможно подтвердить, что запись сделал именно этот врач

**Улучшения (целевое состояние):**

- Перенести медицинские записи в базу данных с шифрованием на уровне отдельных полей (диагнозы, назначения шифруются каждое по отдельности)
- Врач видит только назначенных ему пациентов - доступ проверяется по связке "пациент привязан к конкретному врачу"
- Врачебные записи подписываются электронной подписью - гарантия подлинности и неизменности
- Каждый доступ к медицинским данным фиксируется в журнале аудита, при доступе к особо чувствительным записям система посылает оповещение службе безопасности
- Введено отслеживание истории изменений медицинских данных - можно проследить, кто и когда что менял
- Доступ к медицинским картам ограничен рабочим временем и корпоративной сетью

---

### Процесс 4: Обработка лабораторных анализов

Лаборатория проводит анализы и передает результаты обратно в клинику.

![alt text](<DFD-П4. Лабораторные анализы.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| Направления на анализы | Excel (RegistryByDate.xlsx) | Высокий |
| Результаты анализов | JPG/PDF в папке пациента | Очень Высокий |
| ФИО пациента в реестре | Excel | Высокий |
| Тип анализа | Excel | Высокий |

**Проблемы:**

- Передача результатов анализов между лабораторией и клиникой происходит без шифрования (вручную, на бумаге или по незащищенному каналу)
- Реестр анализов содержит ФИО и медицинские данные в одном файле - утечка одного файла раскрывает все
- Результаты анализов доступны всем сотрудникам на общем диске
- Нет контроля целостности файлов результатов - невозможно понять, изменял ли кто-то файл
- Отсутствует автоматическая интеграция с лабораторией - все передается вручную

**Улучшения (целевое состояние):**

- Заменить ручную передачу на автоматическую интеграцию с лабораторией через защищенный канал с взаимной проверкой подлинности сторон
- В направлении на анализы вместо ФИО использовать обезличенный идентификатор - лаборатория не знает, кому принадлежит анализ
- Результаты анализов подписываются электронной подписью лаборатории - подтверждение подлинности и целостности
- Ограничить доступ к лабораторным данным - только назначенный лечащий врач и сам пациент
- При получении результатов пациенту приходит уведомление "Результаты анализов готовы" без раскрытия содержания
- Вся цепочка "направление -> анализ -> результат -> медицинская карта" отслеживается в системе происхождения данных

---

### Процесс 5: Прием оплаты

Кассир принимает оплату от пациента, проводит через ККМ и фиксирует в двух системах.

![alt text](<DFD-П5. Прием оплаты.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| ФИО пациента | Excel, 1С | Высокий |
| Сумма оплаты | Excel, 1С, ККМ | Средний |
| Наименование услуги | Excel, 1С | Высокий |
| Дата платежа | Excel, 1С, ККМ | Низкий |
| Данные банковской карты | ККМ (транзитом) | Очень Высокий |
| Фискальный чек | ККМ, 1С | Средний |

**Проблемы:**

- Двойной ввод данных (Excel/1С) - риск рассинхронизации и ошибок
- ФИО пациента связано с услугой в платежном документе, что косвенно раскрывает медицинскую информацию (например, "Иванов - УЗИ сердца" = раскрытие диагноза)
- Касса передает данные по незащищенному каналу без шифрования
- Интеграция 1С через устаревший протокол OLE - небезопасна и ненадежна
- Нет аудита доступа к платежным данным

**Улучшения (целевое состояние):**

- Единая система платежей с автоматической синхронизацией - без двойного ввода данных
- Данные банковской карты обрабатываются через сертифицированный платежный шлюз с токенизацией - система клиники никогда не видит номер карты, вместо него используется одноразовый "токен"
- Заменить незащищенное соединение кассы на зашифрованный канал (онлайн-касса через защищенное соединение)
- В платежных записях вместо ФИО использовать обезличенный идентификатор и код услуги (без указания диагноза)
- Заменить устаревшую OLE-интеграцию на современный защищенный интерфейс обмена данными
- Каждый платеж фиксируется в журнале аудита

---

### Процесс 6: Бухгалтерский учет

Бухгалтер обрабатывает платежи, ведет кадровый учет, начисляет зарплаты и готовит налоговую отчетность.

![alt text](<DFD-П6. Бухгалтерский учет.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| ФИО сотрудников | 1С:Бухгалтерия | Высокий |
| Зарплаты | 1С:Бухгалтерия | Очень Высокий |
| ИНН, СНИЛС сотрудников | 1С:Бухгалтерия | Очень Высокий |
| Налоговая отчетность | 1С → файл | Высокий |
| Данные о платежах клиентов | 1С:Бухгалтерия | Высокий |
| Данные о закупках | 1С:Торговля | Средний |

**Проблемы:**

- 1С работает в файловом режиме - нет серверного контроля доступа (любой, кто имеет доступ к файлу базы, видит все)
- Обмен между 1С:Бухгалтерия и 1С:Торговля через устаревший протокол OLE - небезопасно и ненадежно
- Данные кадрового учета (ИНН, зарплаты) хранятся в одной базе с платежными данными клиентов - утечка одной базы раскрывает все
- Excel-отчеты выгружаются на общий диск без защиты - любой сотрудник может их прочитать
- Нет аудита операций в 1С - невозможно узнать, кто и когда смотрел зарплатные данные

**Улучшения (целевое состояние):**

- Перевести 1С в клиент-серверный режим с разграничением прав доступа и аудитом всех операций
- Заменить устаревший OLE-обмен между 1С на защищенный интерфейс обмена данными с шифрованием
- Разделить кадровый и финансовый учет - данные сотрудников (зарплаты, ИНН, СНИЛС) хранить отдельно от данных клиентов
- Убрать выгрузку Excel-отчетов на общий диск - вместо этого использовать аналитическую систему с обезличенными данными (без персональной информации)
- Отправка налоговой отчетности через зашифрованный канал с электронной подписью документов
- Все бухгалтерские операции фиксируются в централизованном журнале аудита

---

### Процесс 7: Учет товарно-материальных ценностей (ТМЦ)

Сотрудник склада ведет учет ТМЦ и закупок в 1С:Торговля и склад.

![alt text](<DFD-П7. Учет ТМЦ.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| Наименование ТМЦ | 1С:Торговля | Низкий |
| Данные поставщиков | 1С:Торговля | Средний |
| Стоимость закупок | 1С:Торговля, 1С:Бухгалтерия | Средний |
| Накладные | 1С:Торговля | Средний |

**Проблемы:**

- 1С в файловом режиме - нет серверного контроля доступа
- OLE-интеграция между 1С системами небезопасна и ненадежна
- Нет разграничения доступа к данным по ролям внутри 1С - складской сотрудник видит финансовые данные бухгалтерии

**Улучшения (целевое состояние):**

- Перевести 1С в клиент-серверный режим с серверным контролем доступа
- Разделить роли: сотрудник склада работает только с данными товаров и остатков, бухгалтер - только с финансовыми итогами
- Заменить OLE на защищенный интерфейс обмена - в бухгалтерию передаются только итоговые суммы, без деталей складских операций
- Вести аудит всех операций с товарными данными
- Соединение с поставщиками - через зашифрованный канал с проверкой подлинности

---

### Процесс 8: Внутренние коммуникации (Exchange Mail Server)

Сотрудники обмениваются данными через корпоративную почту.

![alt text](<DFD-П8. Электронная почта.drawio.png>)

**Данные в потоке:**
| Данные | Формат хранения | Уровень конфиденциальности |
|--------|-----------------|---------------------------|
| Письма с ПДн пациентов | Exchange | Очень Высокий |
| Вложения с мед. данными | Exchange | Очень Высокий |
| Финансовые отчеты | Exchange | Высокий |
| Внутренняя переписка | Exchange | Низкий |

**Проблемы:**

- Сотрудники пересылают конфиденциальные данные (персональные данные пациентов, результаты анализов, финансовые отчеты) по почте без какой-либо защиты
- Нет системы предотвращения утечек данных - можно переслать любые данные на внешний адрес
- Вложения с персональными и медицинскими данными не зашифрованы
- Нет контроля пересылки данных за периметр организации - сотрудник может отправить файл с базой пациентов на личную почту

**Улучшения (целевое состояние):**

- Внедрить систему предотвращения утечек данных - автоматическая проверка всех исходящих писем на наличие персональных и медицинских данных
- Если система обнаруживает в письме персональные данные (ФИО, номер паспорта, диагноз) - отправка блокируется и создается оповещение для службы безопасности
- Шифрование всех писем при передаче и при хранении на сервере
- Заблокировать USB-порты на рабочих станциях для предотвращения копирования данных на флешки
- Установить правило: медицинские данные запрещено передавать по электронной почте - для обмена использовать только защищенные внутренние системы
- Вести журнал всех отправленных писем с вложениями

---

## Аудит безопасности данных

### Сводка выявленных проблем по всей системе

В ходе аудита выявлены следующие системные проблемы, которые затрагивают все процессы компании:

1. **Нет классификации данных.** Компания не разделяет данные по уровню важности. Персональные данные, медицинские записи, финансовые документы и бизнес-информация хранятся вперемешку без какого-либо разграничения.

2. **Нет шифрования.** Все данные хранятся в открытом виде и передаются без шифрования. Любой, кто получит физический доступ к серверу или перехватит сетевой трафик, сможет прочитать все данные.

3. **Нет разграничения доступа.** Все сотрудники имеют доступ ко всем файлам. Администратор ресепшена может видеть зарплатные ведомости, сотрудник склада - медицинские карты пациентов.

4. **Нет журнала действий.** Невозможно узнать, кто, когда и какие данные просматривал или изменял. При утечке данных невозможно провести расследование.

5. **Нет управления согласиями.** Согласия на обработку данных собираются на бумаге, нет электронного учета, нет контроля сроков и возможности отзыва.

6. **Нет политики хранения и удаления данных.** Данные хранятся бессрочно, нет процедуры их удаления, что увеличивает ущерб при утечке.

7. **Данные разных уровней смешаны.** ФИО пациента и название медицинской услуги в одном платежном документе - это фактическое раскрытие диагноза.

8. **Небезопасные каналы передачи.** Касса подключена без шифрования, обмен между системами 1С идет по устаревшему протоколу, почта используется для пересылки медицинских данных.

9. **Нет защиты от утечек.** Любой сотрудник может скопировать все данные на флешку или переслать на личную почту.

10. **Нет плана реагирования на инциденты.** При утечке данных нет понимания, кто и что должен делать. Нет процедуры уведомления Роскомнадзора (требуется по закону в течение 24 часов).

---

## Список данных для защиты и способы защиты

| Данные                                | Уровень важности | Шифрование                                                                  | Обезличивание                                                     | Маскирование                                           |
| ------------------------------------- | ---------------- | --------------------------------------------------------------------------- | ----------------------------------------------------------------- | ------------------------------------------------------ |
| ФИО пациента                          | Высокий          | Шифрование при хранении и передаче                                          | Замена на обезличенный идентификатор при передаче между системами | Частичное скрытие (И\*\*\* И.И.) в журналах и логах    |
| Дата рождения                         | Высокий          | Шифрование при хранении                                                     | Замена на возрастную группу в аналитических отчетах               | Частичное скрытие (**.**.1990) в интерфейсе            |
| Телефон, Email                        | Высокий          | Шифрование при хранении и передаче                                          | -                                                                 | Частичное скрытие (+7***99, i***@mail.ru)              |
| Адрес прописки                        | Высокий          | Шифрование при хранении                                                     | Не собирать при регистрации, если не требуется                    | -                                                      |
| Скан паспорта                         | Очень Высокий    | Шифрование файла при хранении, зашифрованная передача                       | -                                                                 | -                                                      |
| Хронические заболевания               | Очень Высокий    | Шифрование на уровне отдельного поля                                        | -                                                                 | Замена кодами болезней в аналитике                     |
| Диагноз                               | Очень Высокий    | Шифрование на уровне отдельного поля                                        | -                                                                 | Использование кодов болезней вместо текстовых описаний |
| Назначения и рецепты                  | Очень Высокий    | Шифрование на уровне отдельного поля + электронная подпись врача            | -                                                                 | -                                                      |
| Результаты анализов                   | Очень Высокий    | Шифрование файла + зашифрованная передача + электронная подпись лаборатории | Обезличенный идентификатор при передаче в лабораторию             | -                                                      |
| Данные банковской карты               | Очень Высокий    | Токенизация - реальный номер карты заменяется одноразовым "токеном"         | -                                                                 | Показ только последних 4 цифр (\*\*\*\*1234)           |
| ИНН, СНИЛС сотрудников                | Очень Высокий    | Шифрование при хранении                                                     | -                                                                 | Частичное скрытие в интерфейсе                         |
| Зарплаты сотрудников                  | Очень Высокий    | Шифрование при хранении                                                     | -                                                                 | Доступ строго по ролям                                 |
| Наименование мед. услуги (в платежах) | Высокий          | Шифрование при хранении                                                     | Замена на код услуги (без упоминания диагноза)                    | -                                                      |

---

## Механизм тегирования данных

Для управления защитой данных используется система тегов (меток). Каждый элемент данных получает тег, который определяет, какие меры защиты к нему применяются.

### Формат тегов

Тег имеет формат: **категория:подтип:уровень**

Примеры:

- `patient:pii:L3` - персональные данные пациента, уровень 3
- `patient:phi:L4` - медицинские данные пациента, уровень 4 (максимальный)
- `finance:payment:L3` - платежные данные, уровень 3
- `employee:salary:L4` - зарплатные данные сотрудников, уровень 4
- `business:inventory:L2` - данные о товарах на складе, уровень 2

### Уровни защиты

| Уровень | Описание                      | Что означает для данных                                                                                                                                                      |
| ------- | ----------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| L1      | Публичные данные              | Общедоступная информация, шифрование не обязательно                                                                                                                          |
| L2      | Внутренние данные             | Данные для внутреннего пользования. Шифрование при передаче, базовый контроль доступа                                                                                        |
| L3      | Конфиденциальные данные       | Персональные и финансовые данные. Шифрование при хранении и передаче, строгий контроль доступа, аудит                                                                        |
| L4      | Особо конфиденциальные данные | Медицинские данные, зарплаты, данные паспортов. Шифрование каждого поля отдельно, электронная подпись, оповещение при каждом доступе, ограничение по времени и месту доступа |

### Как работает тегирование

1. При создании или получении данных система автоматически назначает тег на основании типа данных
2. Система управления политиками проверяет тег и применяет соответствующие правила защиты
3. При передаче данных между системами тег сохраняется, и принимающая система применяет те же правила
4. В аналитических отчетах данные с тегами уровня L3 и выше автоматически обезличиваются

### Какой инструмент используется

- **Apache Atlas** - каталог данных и управление тегами. Отслеживает, какие данные где хранятся, какие теги у них назначены, и как данные перемещались между системами
- **Apache Ranger** - применение политик доступа на основании тегов. Например, политика: "данные с тегом patient:phi:L4 доступны только врачам, назначенным этому пациенту, и только в рабочее время"

---

## Список инструментов и мер защиты

### Инструменты

| Инструмент                                      | Для чего нужен                                                                                                        | Где используется                                      |
| ----------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| **Keycloak**                                    | Единый вход для сотрудников. Подтверждение личности в два шага (пароль/код). Управление ролями (кто что может делать) | Все процессы - каждый сотрудник входит через Keycloak |
| **PostgreSQL с расширениями**                   | Надежная база данных с шифрованием, разграничением доступа на уровне строк и журналированием                          | Замена Excel-файлов во всех процессах                 |
| **S3-совместимое хранилище**                    | Безопасное хранение файлов (сканы паспортов, результаты анализов) с шифрованием                                       | Замена папок на общем диске                           |
| **HashiCorp Vault**                             | Безопасное хранение ключей шифрования и секретов (паролей, сертификатов)                                              | Все системы, которые используют шифрование            |
| **Apache Atlas**                                | Каталог данных: где какие данные хранятся, какие у них теги, как они перемещаются                                     | Отслеживание данных по всей системе                   |
| **Apache Ranger**                               | Управление доступом на основании тегов: автоматическое применение правил защиты                                       | Все базы данных                                       |
| **Apache NiFi**                                 | Управление потоками данных: маршрутизация, обезличивание, шифрование при передаче                                     | Передача данных между системами и в аналитику         |
| **ELK Stack (Elasticsearch, Logstash, Kibana)** | Сбор и анализ журналов безопасности, обнаружение аномалий, визуализация событий                                       | Мониторинг безопасности по всей системе               |
| **Платежный шлюз**                              | Безопасная обработка платежей по стандарту безопасности платежных данных. Токенизация номеров карт                    | Процесс оплаты                                        |
| **Система предотвращения утечек (DLP)**         | Автоматическая проверка исходящих писем и файлов на наличие конфиденциальных данных                                   | Электронная почта, обмен файлами                      |
| **Kong (шлюз запросов)**                        | Единая точка входа для всех запросов: проверка прав, ограничение частоты, защита от атак                              | Все внешние обращения к системе                       |

### Организационные меры

| Мера                                   | Описание                                                                                    |
| -------------------------------------- | ------------------------------------------------------------------------------------------- |
| Политика обработки персональных данных | Документ, описывающий правила работы с данными в компании                                   |
| Обучение сотрудников                   | Регулярные тренинги по информационной безопасности для всех сотрудников                     |
| План реагирования на инциденты         | Четкий план действий при утечке данных: кто отвечает, что делать, кого уведомлять           |
| Политика ретенции данных               | Правила хранения данных: какие данные сколько хранить и когда автоматически удалять         |
| Запрет передачи мед. данных по почте   | Медицинские данные нельзя пересылать по электронной почте - только через защищенные системы |
| Блокировка USB-портов                  | Предотвращение копирования данных на съемные носители                                       |
